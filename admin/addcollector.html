<!-- register, delete, modify -->

<!DOCTYPE html>
<html lang="en">

<head>
	<title>Portal - Bootstrap 5 Admin Dashboard Template For Developers</title>

	<!-- Meta -->
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<meta name="description" content="Portal - Bootstrap 5 Admin Dashboard Template For Developers">
	<meta name="author" content="Xiaoying Riley at 3rd Wave Media">
	<link rel="shortcut icon" href="favicon.ico">

	<!-- FontAwesome JS-->
	<script defer src="assets/plugins/fontawesome/js/all.min.js"></script>
	<!-- Supabase Library -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

	<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
	<!-- App CSS -->
	<link id="theme-style" rel="stylesheet" href="assets/css/portal.css">

</head>

<body class="app">
	<header class="app-header fixed-top">
		<div class="app-header-inner">
			<div class="container-fluid py-2">
				<div class="app-header-content">
					<div class="row justify-content-between align-items-center">

						<div class="col-auto">
							<a id="sidepanel-toggler" class="sidepanel-toggler d-inline-block d-xl-none" href="#">
								<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30"
									role="img">
									<title>Menu</title>
									<path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10"
										stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path>
								</svg>
							</a>
						</div><!--//col-->



						<div class="app-utilities col-auto">
							<div class="app-utility-item app-notifications-dropdown dropdown">



							</div><!--//app-utility-item-->

							<div class="app-utility-item app-user-dropdown dropdown">
								<a class="dropdown-toggle" id="user-dropdown-toggle" data-bs-toggle="dropdown" href="#"
									role="button" aria-expanded="false"><img src="assets/images/user.png"
										alt="user profile"></a>

								<ul class="dropdown-menu" aria-labelledby="user-dropdown-toggle">

									<li><a href="#" id="logout-btn" class="dropdown-item" href="login.html">Log Out</a>
									</li>

								</ul>
							</div><!--//app-user-dropdown-->
						</div><!--//app-utilities-->
					</div><!--//row-->
				</div><!--//app-header-content-->
			</div><!--//container-fluid-->
		</div><!--//app-header-inner-->
		<div id="app-sidepanel" class="app-sidepanel">
			<div id="sidepanel-drop" class="sidepanel-drop"></div>
			<div class="sidepanel-inner d-flex flex-column">
				<a href="#" id="sidepanel-close" class="sidepanel-close d-xl-none">&times;</a>
				<div class="app-branding">
					<a class="app-logo" href="index.html"><img class="logo-icon me-2" src="assets/images/app-logo.svg"
							alt="logo"><span class="logo-text">ADMIN</span></a>

				</div><!--//app-branding-->

				<nav id="app-nav-main" class="app-nav app-nav-main flex-grow-1">
					<ul class="app-menu list-unstyled accordion" id="menu-accordion">
						<li class="nav-item">
							<!--//Bootstrap Icons: https://icons.getbootstrap.com/ -->
							<a class="nav-link" href="index.html">
								<span class="nav-icon">
									<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-house-door"
										fill="currentColor" xmlns="http://www.w3.org/2000/svg">
										<path fill-rule="evenodd"
											d="M7.646 1.146a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 .146.354v7a.5.5 0 0 1-.5.5H9.5a.5.5 0 0 1-.5-.5v-4H7v4a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .146-.354l6-6zM2.5 7.707V14H6v-4a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4h3.5V7.707L8 2.207l-5.5 5.5z" />
										<path fill-rule="evenodd"
											d="M13 2.5V6l-2-2V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5z" />
									</svg>
								</span>
								<span class="nav-link-text">Dashboard</span>
							</a><!--//nav-link-->
						</li><!--//nav-item-->
						<li class="nav-item">
							<!--//Bootstrap Icons: https://icons.getbootstrap.com/ -->
							<a class="nav-link" href="maps.html">
								<span class="nav-icon">
									<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-folder"
										fill="currentColor" xmlns="http://www.w3.org/2000/svg">
										<path
											d="M9.828 4a3 3 0 0 1-2.12-.879l-.83-.828A1 1 0 0 0 6.173 2H2.5a1 1 0 0 0-1 .981L1.546 4h-1L.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3v1z" />
										<path fill-rule="evenodd"
											d="M13.81 4H2.19a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91h10.348a1 1 0 0 0 .995-.91l.637-7A1 1 0 0 0 13.81 4zM2.19 3A2 2 0 0 0 .198 5.181l.637 7A2 2 0 0 0 2.826 14h10.348a2 2 0 0 0 1.991-1.819l.637-7A2 2 0 0 0 13.81 3H2.19z" />
									</svg>
								</span>
								<span class="nav-link-text">Maps</span>
							</a><!--//nav-link-->
						</li><!--//nav-item-->

						<li class="nav-item has-submenu">
							<a class="nav-link submenu-toggle" href="#" data-bs-toggle="collapse"
								data-bs-target="#submenu-1" aria-expanded="false" aria-controls="submenu-1">
								<span class="nav-icon">
									<!--//Bootstrap Icons: https://icons.getbootstrap.com/ -->
									<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-files"
										fill="currentColor" xmlns="http://www.w3.org/2000/svg">
										<path fill-rule="evenodd"
											d="M4 2h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H4z" />
										<path
											d="M6 0h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2v-1a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6a1 1 0 0 0-1 1H4a2 2 0 0 1 2-2z" />
									</svg>
								</span>
								<span class="nav-link-text">Collection Request</span>
								<span class="submenu-arrow">
									<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-chevron-down"
										fill="currentColor" xmlns="http://www.w3.org/2000/svg">
										<path fill-rule="evenodd"
											d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
									</svg>
								</span><!--//submenu-arrow-->

							</a><!--//nav-link-->
							<div id="submenu-1" class="collapse submenu submenu-1" data-bs-parent="#menu-accordion">
								<ul class="submenu-list list-unstyled">
									<li class="submenu-item"><a class="submenu-link" href="approve.html">Approval
											Request</a></li>
									<li class="submenu-item"><a class="submenu-link" href="logs.html">Logs</a></li>
								</ul>
							</div>
						</li><!--//nav-item-->
						<li class="nav-item has-submenu"></li>
						<a class="nav-link submenu-toggle" href="#" data-bs-toggle="collapse"
							data-bs-target="#submenu-2" aria-expanded="false" aria-controls="submenu-2">
							<span class="nav-icon">
								<!--//Bootstrap Icons: https://icons.getbootstrap.com/ -->
								<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-files"
									fill="currentColor" xmlns="http://www.w3.org/2000/svg">
									<path fill-rule="evenodd"
										d="M4 2h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H4z" />
									<path
										d="M6 0h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2v-1a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6a1 1 0 0 0-1 1H4a2 2 0 0 1 2-2z" />
								</svg>
							</span>
							<span class="nav-link-text">Collection Point</span>
							<span class="submenu-arrow">
								<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-chevron-down"
									fill="currentColor" xmlns="http://www.w3.org/2000/svg">
									<path fill-rule="evenodd"
										d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
								</svg>
							</span><!--//submenu-arrow-->

						</a><!--//nav-link-->
						<div id="submenu-2" class="collapse submenu submenu-2" data-bs-parent="#menu-accordion">
							<ul class="submenu-list list-unstyled">
								<li class="submenu-item"><a class="submenu-link" href="getcurrentstatus.html">Current
										Status</a></li>
								<li class="submenu-item"><a class="submenu-link" href="addcollection.html">Add
										Collection Point</a></li>
							</ul>
						</div>
						</li><!--//nav-item-->
						<li class="nav-item has-submenu"></li>
						<a class="nav-link submenu-toggle" href="#" data-bs-toggle="collapse"
							data-bs-target="#submenu-3" aria-expanded="false" aria-controls="submenu-3">
							<span class="nav-icon">
								<!--//Bootstrap Icons: https://icons.getbootstrap.com/ -->
								<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-files"
									fill="currentColor" xmlns="http://www.w3.org/2000/svg">
									<path fill-rule="evenodd"
										d="M4 2h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H4z" />
									<path
										d="M6 0h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2v-1a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6a1 1 0 0 0-1 1H4a2 2 0 0 1 2-2z" />
								</svg>
							</span>
							<span class="nav-link-text">User</span>
							<span class="submenu-arrow">
								<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-chevron-down"
									fill="currentColor" xmlns="http://www.w3.org/2000/svg">
									<path fill-rule="evenodd"
										d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
								</svg>
							</span><!--//submenu-arrow-->

						</a><!--//nav-link-->
						<div id="submenu-3" class="collapse submenu submenu-3" data-bs-parent="#menu-accordion">
							<ul class="submenu-list list-unstyled">
								<li class="submenu-item"><a class="submenu-link" href="useraccount.html">Account</a>
								</li>
								<li class="submenu-item"><a class="submenu-link" href="userreports.html">Reports</a>
								</li>
							</ul>
						</div>
						</li><!--//nav-item-->
						<li class="nav-item has-submenu"></li>
						<a class="nav-link submenu-toggle active" href="#" data-bs-toggle="collapse"
							data-bs-target="#submenu-4" aria-expanded="false" aria-controls="submenu-4">
							<span class="nav-icon">
								<!--//Bootstrap Icons: https://icons.getbootstrap.com/ -->
								<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-files"
									fill="currentColor" xmlns="http://www.w3.org/2000/svg">
									<path fill-rule="evenodd"
										d="M4 2h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H4z" />
									<path
										d="M6 0h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2v-1a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6a1 1 0 0 0-1 1H4a2 2 0 0 1 2-2z" />
								</svg>
							</span>
							<span class="nav-link-text">Collector</span>
							<span class="submenu-arrow">
								<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-chevron-down"
									fill="currentColor" xmlns="http://www.w3.org/2000/svg">
									<path fill-rule="evenodd"
										d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
								</svg>
							</span><!--//submenu-arrow-->

						</a><!--//nav-link-->
						<div id="submenu-4" class="collapse submenu submenu-4 show" data-bs-parent="#menu-accordion">
							<ul class="submenu-list list-unstyled">
								<li class="submenu-item"><a class="submenu-link active"
										href="addcollector.html">Account</a></li>
								<li class="submenu-item"><a class="submenu-link"
										href="collectorschedule.html">Schedule</a></li>
							</ul>
						</div>
						</li><!--//nav-item-->
					</ul><!--//app-menu-->
				</nav><!--//app-nav-->
			</div><!--//sidepanel-inner-->
		</div><!--//app-sidepanel-->
	</header><!--//app-header-->
	<div class="app-wrapper">
		<div class="app-content pt-3 p-md-3 p-lg-4">
			<div class="container-xl">
				<!-- Page Title -->
				<div class="row g-3 mb-4 align-items-center justify-content-between">
					<div class="col-auto">
						<h1 class="app-page-title mb-0">Collector Management</h1>
					</div>
				</div>

				<!-- Table of Existing Collectors -->
				<div class="row">
					<div class="col-12">
						<table class="table table-bordered">
							<thead>
								<tr>
									<th>Name</th>
									<th>Collection Points & Schedule</th>
									<th>Phone Number</th>
									<th>Email</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody id="collector-table-body">
								<!-- Dynamically populated rows will go here -->
							</tbody>
						</table>
					</div>
				</div>




				<!-- Add New Collector Section -->
				<!-- Page Title -->


				<!-- Add New Collector Section -->
				<div class="row mt-4">
					<div class="col-12">
						<h1 class="app-page-title mb-0">Add New Collector</h1>
						<br>
						<form id="add-collector-form">
							<div class="mb-3">
								<label for="name" class="form-label">Collector Name</label>
								<input type="text" class="form-control" id="name" name="name"
									placeholder="Enter collector's name" required>
							</div>

							<div class="mb-3">
								<label for="phone" class="form-label">Phone Number</label>
								<input type="text" class="form-control" id="phone" name="phone"
									placeholder="Enter phone number" required>
							</div>

							<div class="mb-3">
								<label for="email" class="form-label">Email</label>
								<input type="email" class="form-control" id="email" name="email"
									placeholder="Enter email" required>
							</div>

							<div class="mb-3">
								<label for="password" class="form-label">Password</label>
								<input type="password" class="form-control" id="password" name="password"
									placeholder="Enter password" required>
							</div>

							<!-- Collection Point and Schedule Section -->
							<div id="collection-point-section">
								<div class="collection-point-group mb-3">
									<label for="collectionPoint" class="form-label">Collection Point</label>
									<select class="form-select collectionPoint" name="collectionPoint">
										<!-- Dynamically populated collection points -->
									</select>

									<label class="form-label mt-2">Schedule</label>
									<div class="form-check">
										<input class="form-check-input schedule-checkbox" type="checkbox" value="Monday"
											name="schedule">
										<label class="form-check-label">Monday</label>
									</div>
									<div class="form-check">
										<input class="form-check-input schedule-checkbox" type="checkbox"
											value="Tuesday" name="schedule">
										<label class="form-check-label">Tuesday</label>
									</div>
									<div class="form-check">
										<input class="form-check-input schedule-checkbox" type="checkbox"
											value="Wednesday" name="schedule">
										<label class="form-check-label">Wednesday</label>
									</div>
									<div class="form-check">
										<input class="form-check-input schedule-checkbox" type="checkbox"
											value="Thursday" name="schedule">
										<label class="form-check-label">Thursday</label>
									</div>
									<div class="form-check">
										<input class="form-check-input schedule-checkbox" type="checkbox" value="Friday"
											name="schedule">
										<label class="form-check-label">Friday</label>
									</div>
									<div class="form-check">
										<input class="form-check-input schedule-checkbox" type="checkbox"
											value="Saturday" name="schedule">
										<label class="form-check-label">Saturday</label>
									</div>
								</div>
							</div>

							<button type="button" class="btn btn-secondary" id="add-collection-point">Add Another
								Collection Point</button>
							<br>
							<button type="submit" class="btn btn-primary mt-3">Add Collector</button>
						</form>
					</div>

				</div>



				<div id="spinner-overlay" class="d-none">
					<div class="spinner-container">
						<div class="spinner-border text-primary" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
						<div class="mt-3">Please Wait...</div>
					</div>
				</div>


				<div class="modal fade" id="editCollectorModal" tabindex="-1" aria-labelledby="editCollectorModalLabel"
					aria-hidden="true">
					<div class="modal-dialog modal-lg">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="editCollectorModalLabel">Edit Collector</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal"
									aria-label="Close"></button>
							</div>
							<div class="modal-body">
								<form id="edit-collector-form">
									<input type="hidden" id="edit-collector-id">
									<div class="mb-3">
										<label for="edit-name" class="form-label">Name</label>
										<input type="text" class="form-control" id="edit-name" required>
									</div>
									<div class="mb-3">
										<label for="edit-phone" class="form-label">Phone</label>
										<input type="text" class="form-control" id="edit-phone" required>
									</div>
									<div class="mb-3">
										<label for="edit-email" class="form-label">Email</label>
										<input type="email" class="form-control" id="edit-email" required>
									</div>
									<div id="edit-collection-points">
										<!-- Collection points will be dynamically added here -->
									</div>
									<button type="button" class="btn btn-secondary" id="add-edit-collection-point">Add
										Collection Point</button>
								</form>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
								<button type="button" class="btn btn-primary" id="save-edit-collector">Save
									changes</button>
							</div>
						</div>
					</div>
				</div>


				<style>
					/* Spinner overlay styles */
					#spinner-overlay {
						position: fixed;
						top: 0;
						left: 0;
						width: 100vw;
						height: 100vh;
						background-color: rgba(255, 255, 255, 0.8);
						/* Blur background */
						backdrop-filter: blur(5px);
						/* Blur effect */
						display: flex;
						justify-content: center;
						align-items: center;
						z-index: 1000;
					}

					.spinner-container {
						text-align: center;
					}
				</style>

			</div><!--//app-wrapper-->


			<script>
				const { createClient } = supabase;
				const _supabase = createClient('https://uiciowpyxfawjvaddivu.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVpY2lvd3B5eGZhd2p2YWRkaXZ1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTcyNzE0MDQyMCwiZXhwIjoyMDQyNzE2NDIwfQ.kR8PsVyqtW0QTJoFjFq6aiXU-iq0y3alXfJQIRMVgBw', {
					auth: {
						autoRefreshToken: false, // Disable auto-refreshing of the token
						persistSession: false    // Disable session persistence
					}
				});

				// Access the auth admin API
				const adminAuthClient = _supabase.auth.admin;
				// Fetch collection point by ID
				async function fetchCollectionPointById(cpId) {
					const { data: collectionPoint, error } = await _supabase
						.from('collection_point')
						.select('cp_name')
						.eq('id', cpId)
						.single();

					if (error) {
						console.error(`Error fetching collection point for ID ${cpId}:`, error);
						return null;
					}

					return collectionPoint ? collectionPoint.cp_name : null;
				}

				// Fetch all collectors
				async function fetchCollectors() {
					const { data: collectors, error } = await _supabase
						.from('collector')
						.select('id, name, phone, email, collection_points');

					if (error) {
						console.error('Error fetching collectors:', error);
						return [];
					}

					return collectors;
				}




				async function deleteCollector(collectorId, email) {
					try {
						// 1. Delete the collector from the collector table
						const { error: dbError } = await _supabase
							.from('collector')
							.delete()
							.eq('id', collectorId);

						if (dbError) {
							console.error(`Error deleting collector with ID ${collectorId}:`, dbError);
							return;
						}

						// 2. Fetch the user by email and delete them from Supabase Auth
						const { data: { users }, error: fetchError } = await _supabase.auth.admin.listUsers();

						if (fetchError) {
							console.error('Error fetching users from Supabase Auth:', fetchError);
							return;
						}

						// Find the user with the matching email
						const user = users.find(u => u.email === email);

						if (!user) {
							console.error('User not found for email:', email);
							return;
						}

						// 3. Delete the user role from the user_roles table
						const { error: roleDeleteError } = await _supabase
							.from('user_roles')
							.delete()
							.eq('user_id', user.id);

						if (roleDeleteError) {
							console.error('Error deleting user role:', roleDeleteError);
							return;
						}

						// 4. Delete the user from Supabase Auth
						const { error: deleteError } = await _supabase.auth.admin.deleteUser(user.id);

						if (deleteError) {
							console.error('Error deleting user from Supabase Auth:', deleteError);
							return;
						}

						console.log(`Collector with ID ${collectorId}, user with email ${email}, and associated role deleted successfully.`);
						populateCollectorTable(); // Refresh the table after deletion

					} catch (error) {
						console.error('Error during deletion:', error.message);
					}
				}

				// Handle delete button click
				function handleDeleteButtonClick(event) {
					const collectorId = event.target.getAttribute('data-id');
					const collectorEmail = event.target.getAttribute('data-email'); // This will now correctly retrieve the email
					if (confirm('Are you sure you want to delete this collector?')) {
						deleteCollector(collectorId, collectorEmail);
					}
				}

				// Add event listeners to all delete buttons
				const deleteButtons = document.querySelectorAll('.delete-btn');
				deleteButtons.forEach(button => {
					button.addEventListener('click', handleDeleteButtonClick);
				});

				// Populate the table with collectors' data
				// Populate the table with collectors' data
				async function populateCollectorTable() {
					const collectors = await fetchCollectors();
					const tbody = document.querySelector('tbody');

					// Clear existing table rows
					tbody.innerHTML = '';

					for (const collector of collectors) {
						let collectionPointNames = [];

						// For each collection point in the collector's collection_points array
						for (const cp of collector.collection_points) {
							const cpName = await fetchCollectionPointById(cp.cp_id);
							if (cpName) {
								const schedule = cp.schedule.join(', '); // e.g., Monday, Tuesday
								collectionPointNames.push(`${cpName}: ${schedule}`);
							}
						}

						// Create table row for each collector
						const row = `
    <tr>
        <td>${collector.name}</td>
        <td>${collectionPointNames.join('<br>')}</td>
        <td>${collector.phone}</td>
        <td>${collector.email}</td>
        <td>
            <button class="btn btn-sm btn-primary edit-btn" data-id="${collector.id}">Edit</button>
            <button class="btn btn-sm btn-danger delete-btn" data-id="${collector.id}" data-email="${collector.email}">Delete</button>
        </td>
    </tr>
`;
						tbody.insertAdjacentHTML('beforeend', row);
					}

					// Add event listeners to all delete buttons
					const deleteButtons = document.querySelectorAll('.delete-btn');
					deleteButtons.forEach(button => {
						button.addEventListener('click', handleDeleteButtonClick);
					});
				}


				// Call the function to populate the table on page load
				populateCollectorTable();

				// Call fetchCollectors when the page loads
				document.addEventListener('DOMContentLoaded', fetchCollectors);

				// Fetch available collection points where cp_add_state is 'yes'
				async function fetchCollectionPoints() {
					const { data: collectionPoints, error } = await _supabase
						.from('collection_point')
						.select('id, cp_name')
						.eq('cp_add_state', 'yes');

					if (error) {
						console.error('Error fetching collection points:', error);
						return [];
					}

					return collectionPoints;
				}

				// Fetch all existing collection point schedules
				async function fetchExistingSchedules() {
					const { data: collectors, error } = await _supabase
						.from('collector')
						.select('collection_points');

					if (error) {
						console.error('Error fetching collectors:', error);
						return [];
					}

					// Combine schedules for each collection point from all collectors
					const existingSchedules = {};

					collectors.forEach(collector => {
						collector.collection_points.forEach(point => {
							if (!existingSchedules[point.cp_id]) {
								existingSchedules[point.cp_id] = new Set();
							}
							point.schedule.forEach(day => existingSchedules[point.cp_id].add(day));
						});
					});

					return existingSchedules;
				}

				// Disable checkboxes for already assigned days
				function disableAssignedDays(select, existingSchedules, isEditing = false) {
					const cpId = select.value;
					const checkboxes = select.closest('.collection-point-group').querySelectorAll('.schedule-checkbox');

					if (isEditing) {
						// When editing, enable all checkboxes
						checkboxes.forEach(checkbox => {
							checkbox.disabled = false;
							checkbox.closest('.form-check').style.color = 'black';
						});
					} else {
						// When adding new, disable assigned days
						if (existingSchedules[cpId]) {
							checkboxes.forEach(checkbox => {
								if (existingSchedules[cpId].has(checkbox.value)) {
									checkbox.disabled = true;
									checkbox.closest('.form-check').style.color = 'grey';
								} else {
									checkbox.disabled = false;
									checkbox.closest('.form-check').style.color = 'black';
								}
							});
						} else {
							// Enable all if no existing schedules for the selected collection point
							checkboxes.forEach(checkbox => {
								checkbox.disabled = false;
								checkbox.closest('.form-check').style.color = 'black';
							});
						}
					}
				}

				// Populate the dropdown and apply the disabling logic for assigned days
				async function populateCollectionPointDropdown(select, isEditing = false) {
					select.innerHTML = '<option value="">Select Collection Point</option>';
					const collectionPoints = await fetchCollectionPoints();
					const existingSchedules = await fetchExistingSchedules();

					collectionPoints.forEach(point => {
						const option = document.createElement('option');
						option.value = point.id;
						option.textContent = point.cp_name;
						select.appendChild(option);
					});

					// Add event listener to disable already assigned days when a collection point is selected
					select.addEventListener('change', function () {
						disableAssignedDays(select, existingSchedules, isEditing);
					});
				}

				// Add new collection point row
				document.getElementById('add-collection-point').addEventListener('click', function () {
					const section = document.getElementById('collection-point-section');
					const newCollectionPointGroup = document.querySelector('.collection-point-group').cloneNode(true);
					section.appendChild(newCollectionPointGroup);

					const newSelect = newCollectionPointGroup.querySelector('.collectionPoint');
					populateCollectionPointDropdown(newSelect);
				});

				// Initialize the first collection point dropdown on page load
				document.addEventListener('DOMContentLoaded', function () {
					const firstSelect = document.querySelector('.collectionPoint');
					populateCollectionPointDropdown(firstSelect);
				});

				// Submit the form to add a new collector
				document.getElementById('add-collector-form').addEventListener('submit', async function (e) {
					e.preventDefault();

					const name = document.getElementById('name').value;
					const phone = document.getElementById('phone').value;
					const email = document.getElementById('email').value;
					const password = document.getElementById('password').value;

					document.getElementById('spinner-overlay').classList.remove('d-none');

					const collectionPoints = [];
					document.querySelectorAll('.collectionPoint').forEach((select, index) => {
						const cpId = select.value;
						const schedules = [];
						document.querySelectorAll(`.collection-point-group:nth-of-type(${index + 1}) .schedule-checkbox:checked`).forEach(checkbox => {
							schedules.push(checkbox.value);
						});

						collectionPoints.push({ cp_id: cpId, schedule: schedules });
					});

					try {
						// 1. Register collector using Supabase Auth with display_name
						const { data, error: authError } = await _supabase.auth.signUp({
							email: email,
							password: password,
							options: {
								data: { display_name: name }
							}
						});

						if (authError) {
							throw authError; // Stop the process if auth registration fails
						}

						const user = data.user; // Extract the user object from the data response

						if (!user) {
							throw new Error("User registration failed, user object not found.");
						}

						// 2. Insert collector data into the 'collector' table
						const { data: collectorData, error: dbError } = await _supabase.from('collector').insert({
							name,
							phone,
							email,
							collection_points: collectionPoints
						});

						if (dbError) {
							throw dbError;
						}

						// 3. Insert the user's role into the 'user_roles' table
						const { data: roleData, error: roleError } = await _supabase.from('user_roles').insert({
							user_id: user.id,  // This is the UUID from the auth.users table
							role: 'collector'  // Assign the 'collector' role
						});

						if (roleError) {
							throw roleError;
						}

						document.getElementById('spinner-overlay').classList.add('d-none');
						alert('Collector and role added successfully');

					} catch (error) {
						document.getElementById('spinner-overlay').classList.add('d-none');
						alert(`Error: ${error.message}`);
					}
				});
				///////////////////////


				// Add this after your existing JavaScript code

				let editModal;
				let currentCollector;

				document.addEventListener('DOMContentLoaded', function () {
					editModal = new bootstrap.Modal(document.getElementById('editCollectorModal'));

					// Event delegation for edit buttons
					document.querySelector('tbody').addEventListener('click', function (e) {
						if (e.target.classList.contains('edit-btn')) {
							const collectorId = e.target.getAttribute('data-id');
							openEditModal(collectorId);
						}
					});

					document.getElementById('add-edit-collection-point').addEventListener('click', addEditCollectionPoint);
					document.getElementById('save-edit-collector').addEventListener('click', saveEditCollector);
				});

				async function openEditModal(collectorId) {
					const collector = await fetchCollectorById(collectorId);
					currentCollector = collector;

					document.getElementById('edit-collector-id').value = collector.id;
					document.getElementById('edit-name').value = collector.name;
					document.getElementById('edit-phone').value = collector.phone;
					document.getElementById('edit-email').value = collector.email;

					const collectionPointsContainer = document.getElementById('edit-collection-points');
					collectionPointsContainer.innerHTML = '';

					const existingSchedules = await fetchExistingSchedules();
					const allCollectionPoints = await fetchCollectionPoints();

					collector.collection_points.forEach((point, index) => {
						const collectionPointHtml = `
            <div class="collection-point-group mb-3">
                <label for="edit-collection-point-${index}" class="form-label">Collection Point</label>
                <select class="form-select edit-collection-point collectionPoint" id="edit-collection-point-${index}" name="collectionPoint">
                    <option value="">Select Collection Point</option>
                    ${allCollectionPoints.map(cp => `<option value="${cp.id}" ${cp.id == point.cp_id ? 'selected' : ''}>${cp.cp_name}</option>`).join('')}
                </select>
                <label class="form-label mt-2">Schedule</label>
                ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].map(day => `
                    <div class="form-check">
                        <input class="form-check-input schedule-checkbox" type="checkbox" value="${day}" name="schedule" ${point.schedule.includes(day) ? 'checked' : ''}>
                        <label class="form-check-label">${day}</label>
                    </div>
                `).join('')}
            </div>
        `;
						collectionPointsContainer.insertAdjacentHTML('beforeend', collectionPointHtml);

						const select = document.getElementById(`edit-collection-point-${index}`);
						select.value = point.cp_id; // Ensure the correct collection point is selected

						disableAssignedDays(select, existingSchedules, point.schedule);
					});

					editModal.show();
				}



				async function fetchCollectorById(collectorId) {
					const { data: collector, error } = await _supabase
						.from('collector')
						.select('id, name, phone, email, collection_points')
						.eq('id', collectorId)
						.single();

					if (error) {
						console.error(`Error fetching collector with ID ${collectorId}:`, error);
						return null;
					}

					return collector;
				}

				function addEditCollectionPoint() {
					const collectionPointsContainer = document.getElementById('edit-collection-points');
					const newCollectionPointHtml = `
        <div class="collection-point-group mb-3">
            <label for="edit-collection-point-new" class="form-label">Collection Point</label>
            <select class="form-select edit-collection-point" id="edit-collection-point-new" name="collectionPoint">
                <!-- Options will be populated dynamically -->
            </select>
            <label class="form-label mt-2">Schedule</label>
            <div class="form-check">
                <input class="form-check-input schedule-checkbox" type="checkbox" value="Monday" name="schedule">
                <label class="form-check-label">Monday</label>
            </div>
            <div class="form-check">
                <input class="form-check-input schedule-checkbox" type="checkbox" value="Tuesday" name="schedule">
                <label class="form-check-label">Tuesday</label>
            </div>
            <div class="form-check">
                <input class="form-check-input schedule-checkbox" type="checkbox" value="Wednesday" name="schedule">
                <label class="form-check-label">Wednesday</label>
            </div>
            <div class="form-check">
                <input class="form-check-input schedule-checkbox" type="checkbox" value="Thursday" name="schedule">
                <label class="form-check-label">Thursday</label>
            </div>
            <div class="form-check">
                <input class="form-check-input schedule-checkbox" type="checkbox" value="Friday" name="schedule">
                <label class="form-check-label">Friday</label>
            </div>
            <div class="form-check">
                <input class="form-check-input schedule-checkbox" type="checkbox" value="Saturday" name="schedule">
                <label class="form-check-label">Saturday</label>
            </div>
        </div>
    `;
					collectionPointsContainer.insertAdjacentHTML('beforeend', newCollectionPointHtml);

					const newSelect = document.getElementById('edit-collection-point-new');
					populateCollectionPointDropdown(newSelect);
				}

				async function saveEditCollector() {
					const collectorId = document.getElementById('edit-collector-id').value;
					const name = document.getElementById('edit-name').value;
					const phone = document.getElementById('edit-phone').value;
					const email = document.getElementById('edit-email').value;

					const collectionPoints = [];
					let skippedPoints = 0;

					document.querySelectorAll('.collection-point-group').forEach((group, index) => {
						console.log(`Checking group ${index + 1}`);

						const selectElement = group.querySelector('.edit-collection-point, .collectionPoint');
						if (!selectElement) {
							console.warn(`No select element found in group ${index + 1}`);
							skippedPoints++;
							return;
						}

						const cpId = selectElement.value;
						console.log(`Group ${index + 1} - Selected CP ID: ${cpId}`);

						if (!cpId) {
							console.warn(`No collection point selected for group ${index + 1}`);
							skippedPoints++;
							return;
						}

						const schedules = [];
						group.querySelectorAll('.schedule-checkbox:checked').forEach(checkbox => {
							schedules.push(checkbox.value);
						});
						console.log(`Group ${index + 1} - Selected schedules: ${schedules.join(', ')}`);

						if (schedules.length === 0) {
							console.warn(`No schedule selected for collection point in group ${index + 1}`);
							skippedPoints++;
							return;
						}

						collectionPoints.push({ cp_id: cpId, schedule: schedules });
						console.log(`Added collection point for group ${index + 1}`);
					});

					console.log(`Total collection points: ${collectionPoints.length}, Skipped points: ${skippedPoints}`);

					if (collectionPoints.length === 0) {
						alert('Please select at least one collection point and schedule.');
						return;
					}

					if (skippedPoints > 0) {
						const confirmMessage = `${skippedPoints} are you sure?`;
						if (!confirm(confirmMessage)) {
							return;
						}
					}

					try {
						const { error: dbError } = await _supabase
							.from('collector')
							.update({
								name,
								phone,
								email,
								collection_points: collectionPoints
							})
							.eq('id', collectorId);

						if (dbError) {
							console.error(`Error updating collector with ID ${collectorId}:`, dbError);
							alert('An error occurred while updating the collector. Please try again.');
							return;
						}

						alert('Collector updated successfully!');
						editModal.hide();
						populateCollectorTable(); // Refresh the table after update
					} catch (error) {
						console.error('Error during update:', error.message);
						alert('An unexpected error occurred. Please try again.');
					}
				}
			</script>




			<!-- Javascript -->
			<script src="assets/plugins/popper.min.js"></script>
			<script src="assets/plugins/bootstrap/js/bootstrap.min.js"></script>


			<!-- Page Specific JS -->
			<script src="assets/js/app.js"></script>
			<script>

				document.getElementById('logout-btn').addEventListener('click', async function () {
					const { error } = await _supabase.auth.signOut();
					if (error) {
						console.error('Error logging out:', error.message);
						alert('Logout failed. Please try again.');
					} else {
						localStorage.removeItem('supabase.auth.token');
						window.location.href = '../user/login.html';
						console.log("User logged out successfully");
					}
				});

			</script>

</body>

</html>