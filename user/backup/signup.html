<!DOCTYPE html>
<html lang="en">
<head>
    <title>Solid Waste Urdaneta Portal Sign Up</title>
    
    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="description" content="Portal - Bootstrap 5 Admin Dashboard Template For Developers">
    <meta name="author" content="Xiaoying Riley at 3rd Wave Media">    
    <link rel="shortcut icon" href="favicon.ico"> 
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script defer src="assets/plugins/fontawesome/js/all.min.js"></script>
    
    <!-- App CSS -->  
    <link id="theme-style" rel="stylesheet" href="assets/css/portal.css">

    <!-- SweetAlert CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        body, .app {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            position: relative;
            background-color: #cadfaf;
            font-family: 'Arial', sans-serif;
        }
    
        .background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('Trash.png');
            background-size: cover;
            background-position: center;
            z-index: -1;
            opacity: 0.7;
        }
    
        .form-box {
            background-color: #006400;
            padding: 40px;
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }
    
        .form-box h2 {
            color: white;
            text-align: center;
            font-size: 32px;
            margin-bottom: 20px;
        }
    
        .auth-form-container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
        }
    
        input.form-control {
            background-color: #f9f9f9;
            border: 2px solid #ccc;
            padding: 15px;
            font-size: 16px;
            border-radius: 10px;
            box-shadow: inset 0px 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
    
        input.form-control:focus {
            border-color: #006400;
            outline: none;
            box-shadow: 0px 0px 10px rgba(0, 100, 0, 0.1);
        }
    
        .form-check-input {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
    
        .form-check-label {
            font-size: 16px;
            color: #444;
        }
    
        .btn.app-btn-primary {
            background-color: #006400;
            color: white;
            font-size: 18px;
            padding: 12px 0;
            border: none;
            border-radius: 50px;
            transition: all 0.3s ease;
        }
    
        .btn.app-btn-primary:hover {
            background-color: #004d00;
            box-shadow: 0px 8px 15px rgba(0, 100, 0, 0.3);
            transform: translateY(-3px);
        }
    
        .auth-option {
            font-size: 14px;
            margin-top: 20px;
            color: #006400;
        }
    
        .text-link {
            color: #004d00;
            font-weight: bold;
            text-decoration: underline;
        }
    
        .text-link:hover {
            color: #006400;
        }
    
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .form-box {
                padding: 20px;
                max-width: 100%;
            }
    
            input.form-control {
                font-size: 14px;
                padding: 12px;
            }
    
            .btn.app-btn-primary {
                font-size: 16px;
                padding: 10px 0;
            }
        }
    </style>

</head> 

<body class="app app-signup p-0">     
    <div class="background-image"></div> 

    <div class="form-box">
        <div class="app-auth-body mx-auto">  
            <h2 class="auth-heading text-center mb-4">Create Account</h2>                    

            <div class="auth-form-container text-start mx-auto">
                <form class="auth-form auth-signup-form" id="MainForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="sr-only" for="signup-fname">First Name</label>
                            <input id="firstnameInp" name="signup-fname" type="text" class="form-control signup-name" placeholder="First name" required="required">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="sr-only" for="signup-lname">Last Name</label>
                            <input id="secondnameInp" name="signup-lname" type="text" class="form-control signup-name" placeholder="Last name" required="required">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="sr-only" for="signup-phoneNum">Phone Number</label>
                            <input id="phoneInp" name="signup-phoneNum" type="text" class="form-control signup-name" placeholder="Phone Number" required="required">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="sr-only" for="signup-email">Your Email</label>
                            <input id="emailInp" name="signup-email" type="email" class="form-control signup-email" placeholder="Email" required="required">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="sr-only" for="signup-password">Password</label>
                            <input id="passwordInp" name="signup-password" type="password" class="form-control signup-password" placeholder="Create a password" required="required">
                        </div>
                    </div>
                    <div class="extra mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="RememberPassword" required>
                            <label class="form-check-label" for="RememberPassword">
                            I agree to Portal's <a href="terms.html" class="app-link">Terms of Service</a> and <a href="privacy.html" class="app-link">Privacy Policy</a>.
                            </label>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn app-btn-primary w-100 theme-btn mx-auto">Create</button>
                    </div>
                </form>
                
                <div class="auth-option text-center pt-5">Already have an account? <a class="text-link" href="login.html" >Log in</a></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


   <script>
   document.addEventListener("DOMContentLoaded", function () {
    const { createClient } = supabase;
        const _supabase = createClient('https://uiciowpyxfawjvaddivu.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVpY2lvd3B5eGZhd2p2YWRkaXZ1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTcyNzE0MDQyMCwiZXhwIjoyMDQyNzE2NDIwfQ.kR8PsVyqtW0QTJoFjFq6aiXU-iq0y3alXfJQIRMVgBw');


    document.getElementById('MainForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const firstName = document.getElementById('firstnameInp').value;
        const lastName = document.getElementById('secondnameInp').value;
        const phoneNumber = document.getElementById('phoneInp').value;
        const email = document.getElementById('emailInp').value;
        const password = document.getElementById('passwordInp').value;

        try {
            console.log("Starting user registration process...");
            console.log("Step 1: Creating user in auth table...");
            const { data: user, error: authError } = await _supabase.auth.signUp({
                email: email,
                password: password,
            });

            if (authError) {
                throw new Error(`Error signing up user: ${authError.message}`);
            }
            console.log("User created in auth table:", user.user.id);
            console.log("Step 2: Inserting user info...");
            const { data: userInfoData, error: userInfoError } = await _supabase
                .from('user_info')
                .insert([
                    { 
                        first_name: firstName, 
                        last_name: lastName, 
                        phone_number: phoneNumber, 
                        email: email,
                        auth_id: user.user.id  
                    }
                ])
                .select();

            if (userInfoError) {
                throw new Error(`Error inserting into user_info: ${userInfoError.message}`);
            }
            console.log("User info inserted:", userInfoData);


            console.log("Step 3: Inserting user role...");
            const { data: roleData, error: roleError } = await _supabase
                .from('user_roles')
                .insert([
                    { user_id: user.user.id, role: 'user' } 
                ]);

            if (roleError) {
                throw new Error(`Error inserting into user_roles: ${roleError.message}`);
            }
            console.log("User role inserted:", roleData);

            Swal.fire({
                title: 'Success!',
                text: 'Your account has been created successfully!',
                icon: 'success',
            });

            window.location.href = 'login.html';

        } catch (error) {
            console.error("Registration error:", error);
            Swal.fire({
                title: 'Error!',
                text: error.message,
                icon: 'error',
            });
        }
    });
});

    </script>
</body>
</html>